<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Monitoreo Industrial IoT</title>

    <!-- Pequeño CSS inline para evitar parpadeo inicial -->
    <style>
        /* Mantener body oculto hasta que JS aplique el tema/estado ready */
        body { opacity: 0; transition: opacity 160ms ease-out; }
    </style>

    <!-- Hojas de estilo del usuario -->
    <link rel="stylesheet" href="industrial.css" />
    <link rel="stylesheet" href="industrial-advanced.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Favicon (SVG inline data URI) - viewBox corregido -->
    <link rel="icon" type="image/svg+xml"
          href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%94%99%3C/text%3E%3C/svg%3E" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
          rel="stylesheet" />
</head>

<!-- Script inicial justo después del body abierto: aplica tema y marca body como listo lo antes posible -->
<body class="operator-theme">
<script>
    (function() {
        'use strict';
        try {
            // Aplicar tema guardado (lo más pronto posible)
            const saved = localStorage.getItem('iot_theme');
            const theme = saved || 'operator';
            // Si body existe (estamos justo después de <body>), aplicamos inmediatamente
            (function applyTheme() {
                try {
                    // Remover posibles clases de tema conocidas y añadir la guardada
                    document.body.classList.remove('operator-theme', 'supervisor-theme');
                    document.body.classList.add(`${theme}-theme`);
                } catch (e) { /* ignore */ }
            })();
            // Marcar que el tema/estilos están listos para que la hoja industrial.css no oculte el body
            try {
                document.body.classList.add('theme-loaded');
            } catch (e) { /* ignore */ }
        } catch (err) {
            console.warn('early theme apply failed', err);
        }
    })();
</script>

    <!-- Error Overlay (oculto por defecto) -->
    <div id="app-error" class="hidden" aria-hidden="true">
        <!-- Se llena dinámicamente en caso de error -->
    </div>

    <!-- Encabezado (Visible solo si está autenticado) -->
    <header id="app-header" class="hidden" role="banner">
        <div class="header-left">
            <div class="logo" aria-hidden="true">
                <i class="fas fa-industry" aria-hidden="true"></i>
                <h1>Sistema IoT Industrial</h1>
            </div>
            <div class="status-bar" role="status" aria-live="polite">
                <span id="connection-status" class="connection-status status-offline">
                    <i class="fas fa-circle"></i> Sin conexión
                </span>
                <span id="last-update">Última actualización: --:--:--</span>
            </div>
        </div>
        <div class="header-right">
            <nav id="main-nav" class="nav-menu" role="navigation" aria-label="Navegación principal">
                <a href="#dashboard" class="nav-item active">
                    <i class="fas fa-chart-area" aria-hidden="true"></i> Dashboard
                </a>
                <a href="#alerts" class="nav-item">
                    <i class="fas fa-bell" aria-hidden="true"></i> Alertas
                    <span id="active-alerts-count" class="alert-badge" aria-live="polite">0</span>
                </a>

                <!-- Elementos visibles solo para el rol Supervisor -->
                <a href="#analysis" class="nav-item supervisor-only hidden">
                    <i class="fas fa-chart-line" aria-hidden="true"></i> Análisis
                </a>
                <a href="#reports" class="nav-item supervisor-only hidden">
                    <i class="fas fa-file-alt" aria-hidden="true"></i> Reportes
                </a>
                <a href="#config" class="nav-item supervisor-only hidden">
                    <i class="fas fa-cog" aria-hidden="true"></i> Configuración
                </a>
            </nav>
            <div class="user-controls" aria-label="Controles de usuario">
                <span id="user-info" aria-hidden="false">
                    Usuario: <strong id="current-username"></strong>
                    (<span id="current-role"></span>)
                </span>
                <button id="theme-toggle" class="btn-icon" title="Cambiar Tema" aria-pressed="false">
                    <i class="fas fa-lightbulb" aria-hidden="true"></i>
                </button>
                <button id="logout-btn" class="btn-icon" title="Cerrar Sesión">
                    <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Contenedor principal de la aplicación SPA -->
    <main id="app-main" role="main">
        <!-- ------------------- PÁGINA DE LOGIN ------------------- -->
        <div id="login-page" class="page active" aria-hidden="false">
            <div class="login-card" role="form" aria-labelledby="login-title">
                <h2 id="login-title"><i class="fas fa-lock" aria-hidden="true"></i> Acceso al Sistema IoT</h2>
                <form id="login-form" autocomplete="on">
                    <div class="input-group">
                        <label for="username">Usuario:</label>
                        <input type="text" id="username" required
                               placeholder="ej: operador / supervisor"
                               autocomplete="username">
                    </div>
                    <div class="input-group">
                        <label for="password">Contraseña:</label>
                        <input type="password" id="password" required
                               placeholder="op123 / sup123"
                               autocomplete="current-password">
                    </div>
                    <p id="login-error" class="error-message hidden" role="alert" aria-hidden="true"></p>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-sign-in-alt" aria-hidden="true"></i> Iniciar Sesión
                    </button>
                </form>
                <div class="demo-info" aria-hidden="false">
                    <p><strong>Credenciales de Demostración:</strong></p>
                    <p><i class="fas fa-user" aria-hidden="true"></i> Operador: operador / op123</p>
                    <p><i class="fas fa-user-shield" aria-hidden="true"></i> Supervisor: supervisor / sup123</p>
                    <p class="small-note">
                        <i class="fas fa-info-circle" aria-hidden="true"></i>
                        El supervisor tiene acceso a todas las funcionalidades
                    </p>
                </div>
            </div>
        </div>

        <!-- ------------------- PÁGINA DE DASHBOARD ------------------- -->
        <div id="dashboard-page" class="page hidden" aria-hidden="true">
            <div class="page-header">
                <h2><i class="fas fa-chart-area" aria-hidden="true"></i> Dashboard Principal</h2>
                <div class="header-actions">
                    <button id="refresh-data" class="btn-icon" title="Refrescar Datos">
                        <i class="fas fa-sync-alt" aria-hidden="true"></i> Refrescar
                    </button>
                    <div id="connection-display" class="connection-status status-connecting" aria-live="polite">
                        <i class="fas fa-sync fa-spin" aria-hidden="true"></i> Conectando...
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- Contenedores para Paneles de Motores -->
                <div id="motor1-container" class="card motor-panel" aria-live="polite">
                    <!-- Se llena dinámicamente por MotorCoordinator -->
                </div>

                <div id="motor2-container" class="card motor-panel" aria-live="polite">
                    <!-- Se llena dinámicamente por MotorCoordinator -->
                </div>

                <!-- Panel de Alertas Activas -->
                <div class="card alerts-card full-width">
                    <h3><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Alertas Activas</h3>
                    <div id="alerts-container" class="alerts-list" aria-live="polite">
                        <p class="no-alerts">No hay alertas activas</p>
                    </div>
                </div>

                <!-- Gráfico de Tendencias -->
                <div class="card chart-card full-width" role="region" aria-label="Tendencia de datos últimas 24 horas">
                    <h3><i class="fas fa-chart-line" aria-hidden="true"></i> Tendencia de Datos (Últimas 24h)</h3>
                    <div class="chart-controls">
                        <label for="chart-variable">Variable:</label>
                        <select id="chart-variable" aria-controls="trend-chart">
                            <option value="temperature">Temperatura</option>
                            <option value="oil_pressure">Presión de Aceite</option>
                            <option value="clutch_pressure">Presión de Clutch</option>
                        </select>
                        <label for="chart-motor">Motor:</label>
                        <select id="chart-motor" aria-controls="trend-chart">
                            <option value="m1">Motor Principal</option>
                            <option value="m2">Motor Secundario</option>
                            <option value="both">Ambos Motores</option>
                        </select>
                    </div>
                    <div class="chart-area-wrapper">
                        <canvas id="trend-chart" role="img" aria-label="Gráfico de tendencia"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ------------------- PÁGINA DE GESTIÓN DE ALERTAS ------------------- -->
        <div id="alerts-page" class="page hidden" aria-hidden="true">
            <div class="page-header">
                <h2><i class="fas fa-bell" aria-hidden="true"></i> Gestión e Historial de Alertas</h2>
                <div class="header-actions">
                    <button id="clear-resolved-alerts" class="btn-secondary">
                        <i class="fas fa-trash" aria-hidden="true"></i> Limpiar Resueltas
                    </button>
                </div>
            </div>
            <div class="alerts-management-content">
                <div class="card">
                    <h3><i class="fas fa-filter" aria-hidden="true"></i> Filtros de Alertas</h3>
                    <div class="filter-controls">
                        <div class="input-group">
                            <label for="filter-severity">Severidad:</label>
                            <select id="filter-severity">
                                <option value="all">Todas</option>
                                <option value="critical">Crítica</option>
                                <option value="warning">Advertencia</option>
                                <option value="info">Informativa</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="filter-motor">Motor:</label>
                            <select id="filter-motor">
                                <option value="all">Todos</option>
                                <option value="motor1">Motor Principal</option>
                                <option value="motor2">Motor Secundario</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="filter-resolved">Estado:</label>
                            <select id="filter-resolved">
                                <option value="all">Todos</option>
                                <option value="active">Activas</option>
                                <option value="resolved">Resueltas</option>
                            </select>
                        </div>

                        <button id="apply-filter-btn" class="btn-primary">
                            <i class="fas fa-filter" aria-hidden="true"></i> Aplicar Filtros
                        </button>
                    </div>

                    <div class="alert-stats">
                        <h4>Estadísticas:</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-label">Total</span>
                                <span class="stat-value" id="total-alerts">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Activas</span>
                                <span class="stat-value" id="active-alerts-stats">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Críticas</span>
                                <span class="stat-value critical" id="critical-alerts">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card full-width">
                    <h3><i class="fas fa-history" aria-hidden="true"></i> Historial Completo de Alertas</h3>
                    <div id="full-alerts-list" class="alerts-history-list" aria-live="polite">
                        <!-- El historial de alertas se renderizará aquí -->
                        <div class="loading-alerts">
                            <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
                            <p>Cargando historial de alertas...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ------------------- PÁGINAS DE SUPERVISOR (simuladas) ------------------- -->
        <div id="analysis-page" class="page supervisor-only hidden" aria-hidden="true">
            <div class="page-header">
                <h2><i class="fas fa-chart-line" aria-hidden="true"></i> Análisis Detallado</h2>
            </div>
            <div class="card analysis-content">
                <h3>Gráficos Comparativos Avanzados</h3>
                <p>Aquí se integrarían gráficos de comparación (e.g., barras de eficiencia, dispersión de variables) y estadísticas avanzadas sobre el rendimiento de los motores a lo largo de períodos seleccionables.</p>
                <div class="analysis-controls">
                    <button class="btn-primary">
                        <i class="fas fa-file-pdf" aria-hidden="true"></i> Reporte de Eficiencia Mensual
                    </button>
                    <button class="btn-secondary">
                        <i class="fas fa-chart-bar" aria-hidden="true"></i> Análisis Comparativo
                    </button>
                </div>
            </div>
        </div>

        <div id="reports-page" class="page supervisor-only hidden" aria-hidden="true">
            <div class="page-header">
                <h2><i class="fas fa-file-alt" aria-hidden="true"></i> Reportes</h2>
            </div>
            <div class="card reports-content">
                <h3>Generación y Historial de Reportes</h3>
                <p>Esta sección permitiría al supervisor generar reportes en PDF o CSV. Se simula una funcionalidad clave.</p>
                <div class="report-actions">
                    <button class="btn-primary">
                        <i class="fas fa-file-pdf" aria-hidden="true"></i> Generar Reporte PDF (Últimas 24h)
                    </button>
                    <button class="btn-secondary">
                        <i class="fas fa-file-csv" aria-hidden="true"></i> Exportar Datos CSV
                    </button>
                    <button class="btn-secondary">
                        <i class="fas fa-calendar-alt" aria-hidden="true"></i> Reporte Programado
                    </button>
                </div>
                <h4><i class="fas fa-clock" aria-hidden="true"></i> Reportes Programados:</h4>
                <ul class="simple-list">
                    <li>
                        <i class="fas fa-check-circle text-success" aria-hidden="true"></i>
                        Reporte de Desempeño Semanal (Próxima ejecución: Lunes 9:00 AM)
                    </li>
                    <li>
                        <i class="fas fa-check-circle text-success" aria-hidden="true"></i>
                        Resumen de Alertas Mensual (Última ejecución: 01/10/2024)
                    </li>
                    <li>
                        <i class="fas fa-times-circle text-danger" aria-hidden="true"></i>
                        Auditoría de Sistema (Programación pendiente)
                    </li>
                </ul>
            </div>
        </div>

        <div id="config-page" class="page supervisor-only hidden" aria-hidden="true">
            <div class="page-header">
                <h2><i class="fas fa-cog" aria-hidden="true"></i> Configuración</h2>
            </div>
            <div class="config-grid">
                <div class="card config-section">
                    <h3><i class="fas fa-user-shield" aria-hidden="true"></i> Gestión de Usuarios</h3>
                    <p>Funcionalidad para añadir/editar usuarios y cambiar roles.</p>
                    <div class="config-actions">
                        <button class="btn-primary">Agregar Usuario</button>
                        <button class="btn-secondary">Editar Roles</button>
                    </div>
                </div>
                <div class="card config-section">
                    <h3><i class="fas fa-exclamation-circle" aria-hidden="true"></i> Umbrales de Alerta</h3>
                    <p>Ajuste de los valores de umbral crítico y de advertencia para los motores.</p>
                    <div class="config-actions">
                        <button class="btn-primary">Configurar Motor 1</button>
                        <button class="btn-secondary">Configurar Motor 2</button>
                    </div>
                </div>
                <div class="card config-section">
                    <h3><i class="fas fa-tachometer-alt" aria-hidden="true"></i> Intervalos y Retención</h3>
                    <p>Ajustes generales del sistema como el intervalo de actualización de polling y la retención de datos históricos.</p>
                    <div class="config-actions">
                        <button class="btn-primary">Ajustar Intervalos</button>
                        <button class="btn-secondary">Configurar Retención</button>
                    </div>
                </div>
                <div class="card config-section">
                    <h3><i class="fas fa-palette" aria-hidden="true"></i> Personalización UI</h3>
                    <p>Configuración de temas, colores y preferencias de visualización.</p>
                    <div class="config-actions">
                        <button class="btn-primary">Temas Personalizados</button>
                        <button class="btn-secondary">Ajustar Colores</button>
                    </div>
                </div>
                <div class="card config-section">
                    <h3><i class="fas fa-bell" aria-hidden="true"></i> Notificaciones</h3>
                    <p>Configuración de alertas por email, SMS y preferencias de notificación.</p>
                    <div class="config-actions">
                        <button class="btn-primary">Configurar Email</button>
                        <button class="btn-secondary">Preferencias SMS</button>
                    </div>
                </div>
                <div class="card config-section">
                    <h3><i class="fas fa-database" aria-hidden="true"></i> Base de Datos</h3>
                    <p>Gestión de respaldos, limpieza y mantenimiento de la base de datos.</p>
                    <div class="config-actions">
                        <button class="btn-primary">Respaldar Datos</button>
                        <button class="btn-secondary">Optimizar DB</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer id="app-footer" class="hidden" role="contentinfo">
        <div class="footer-content">
            <p>
                <i class="fas fa-industry" aria-hidden="true"></i>
                Sistema de Monitoreo Industrial IoT v2.0 |
                <span id="version-info">Arquitectura Modular</span>
            </p>
            <p id="footer-system-status">
                Estado del sistema: <span class="status-normal">Normal</span>
            </p>
            <p class="footer-meta">
                <span id="server-time">--:--:--</span> |
                <span id="data-version">Datos: v1.0.0</span>
            </p>
        </div>
    </footer>

    <!-- Script para mostrar body suavemente cuando todo cargue -->
    <script>
        window.addEventListener('load', function() {
            // Mostrar el body en la siguiente raf para evitar pinturas intermedias
            requestAnimationFrame(() => {
                try { document.body.style.opacity = '1'; } catch (e) { /* ignore */ }
            });
        });

        // También, si por alguna razón load no llega rápido, liberar en 900ms (fallback)
        setTimeout(() => {
            if (document.body && getComputedStyle(document.body).opacity === '0') {
                try { document.body.style.opacity = '1'; } catch (e) { /* ignore */ }
            }
        }, 900);
    </script>
    
    <!-- Scripts Modulares (ES6 Modules) -->
    <script type="module">
        // Importar módulos (respetar el orden del proyecto)
        import './config.js';
        import './auth.js';
        import './components/Gauge.js';
        import './components/MotorPanel.js';
        import './components/TrendChart.js';
        import './services/websocket-service.js';
        import './modules/alerts/alert-manager.js';
        import './modules/ui/theme-manager.js';
        import './modules/dashboard/dashboard-controller.js';
        import './app.js';

        // Inicializaciones no bloqueantes
        window.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('Sistema Industrial IoT - Cargado');

                // Inicializar tema desde localStorage (seguro)
                const savedTheme = localStorage.getItem('iot_theme');
                if (savedTheme) {
                    document.body.classList.remove('operator-theme', 'supervisor-theme');
                    document.body.classList.add(`${savedTheme}-theme`);
                }

                // Mostrar información de versión
                const versionEl = document.getElementById('version-info');
                if (versionEl) {
                    versionEl.textContent = `Arquitectura Modular | Build: ${new Date().toISOString().split('T')[0]}`;
                }

                // Actualizar hora del servidor (simulada)
                const serverTimeEl = document.getElementById('server-time');
                if (serverTimeEl) {
                    setInterval(() => {
                        const now = new Date();
                        serverTimeEl.textContent = now.toLocaleTimeString('es-ES', { hour12: false });
                    }, 1000);
                }
            } catch (err) {
                console.error('Error en inicialización DOMContentLoaded:', err);
            }
        });
    </script>
</body>
</html>
